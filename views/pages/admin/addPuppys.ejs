<!doctype html>
<html lang="fr" data-bs-theme="auto">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>Gestion des Chiots</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://kit.fontawesome.com/1365cc5822.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/admin/css/dashboard.css">
    <link rel="stylesheet" href="/admin/css/puppys.css">
    <link rel="stylesheet" href="/admin/css/sidebar.css">
    <script src="/admin/js/themes/darkThemeFunction.js"></script>
</head>
  <body>
    <%- include('../admin/composants/header') %>
    <%- include('../admin/composants/topBar') %>
        <div class="container">
            <div class="input-group mb-3">
                <span class="input-group-text" id="basic-addon1">Recherche</span>
                <input type="text" class="form-control" id="searchInput" placeholder="Nom de l'animal" aria-label="Animal name" aria-describedby="basic-addon1" value="<%= search %>">
            </div>
            <div class="row marriage-container " style="min-height:800px;">
                <% marriages.forEach(marriage => { 
                    const male = animals.find(animal => animal.id === marriage.male_id);
                    const female = animals.find(animal => animal.id === marriage.female_id);
                %>
                    <div class="col-sm-12 col-md-12 col-lg-4 mb-4 marriage-block" data-male-name="<%= male.name %>" data-female-name="<%= female.name %>">
                        <div class="card text-light card-has-bg click-col" style="background-image: url('/uploads/<%= marriage.image_path %>');">
                            <div class="status-badge <%= marriage.is_online ? 'status-online' : 'status-offline' %>">
                                <%= marriage.is_online ? 'En Ligne' : 'Hors-ligne' %>
                            </div>
                            <img class="card-img d-none " src="/uploads/<%= marriage.image_path %>" alt="mariage de <%= male.name %> ( <%= male.breed_type %>, <%= male.color %> ) et <%= female.name %> ( <%= female.breed_type %>, <%= female.color %> )">
                            <div class="card-img-overlay d-flex flex-column ">
                                <div class="card-body">
                                    <small class="card-meta mb-2"><%= male.name %> x <%= female.name %></small><br>
                                    <small>
                                        <i class="far fa-clock"></i> Date prévue : 
                                        <%= marriage.expected_birth_date && marriage.expected_birth_date !== '0000-00-00' ? marriage.expected_birth_date : 'En Attente' %>
                                    </small><br>
                                    <small>
                                        <i class="far fa-clock"></i> Naissance : 
                                        <%= (!marriage.actual_birth_date || marriage.actual_birth_date === '0000-00-00') ? 'En Attente' : marriage.actual_birth_date %>
                                    </small><br>
                                    <small>
                                        <i class="fas fa-paw"></i> Chiots attendus : 
                                        <%= marriage.expected_puppies ? marriage.expected_puppies : 'En Attente' %>
                                    </small><br>
                                    <small>
                                        <i class="fas fa-paw"></i> Chiots nés : 
                                        <% if ((marriage.actual_male_puppies && parseInt(marriage.actual_male_puppies) > 0) || (marriage.actual_female_puppies && parseInt(marriage.actual_female_puppies) > 0)) { %>
                                            <%= (parseInt(marriage.actual_male_puppies) || 0) + (parseInt(marriage.actual_female_puppies) || 0) %>
                                        <% } else { %>
                                            En Attente
                                        <% } %>
                                    </small><br>
                                    <small>
                                        <i class="bi bi-gender-male text-primary" ></i>
                                        <%= marriage.actual_male_puppies || '0' %> <br>
                                        <i class="bi bi-gender-female" style="color: pink;"></i> 
                                        <%= marriage.actual_female_puppies || '0' %>
                                    </small>
                                </div>
                                <div class="card-footer align-items-center">
                                    <div class="media">
                                        <img id="father-image" class="mr-3 rounded-circle mb-5 mt-5" src="/uploads/<%= male.image_path_profile %>" alt="Image du père" style="max-width:120px; border: 2px solid blue;">
                                        <img id="mother-image" class="mr-3 rounded-circle mb-5 mt-5" src="/uploads/<%= female.image_path_profile %>" alt="Image de la mère" style="max-width:120px; border: 2px solid pink;">
                                        <div class="media-body">
                                            <a href="/admin/puppies/<%= marriage.id %>" id="puppyWarningModalBtn" class="btn btn-primary view-puppies-btn w-100 <%= (marriage.actual_male_puppies || 0) === 0 && (marriage.actual_female_puppies || 0) === 0 ? 'disabled' : '' %>" style="border: 2px solid #cfa636; border-radius: 10px;">
                                                Voir les chiots <i class="bi bi-eye"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
            <div class="row">
                <div class="col">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-center mt-4">
                            <% if (currentPage > 1) { %>
                                <li class="page-item">
                                    <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= search %>">Précédente</a>
                                </li>
                            <% } else { %>
                                <li class="page-item disabled">
                                    <a class="page-link">Précédente</a>
                                </li>
                            <% } %>
        
                            <% for (let i = 1; i <= totalPages; i++) { %>
                                <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                    <a class="page-link" href="?page=<%= i %>&search=<%= search %>"><%= i %></a>
                                </li>
                            <% } %>
        
                            <% if (currentPage < totalPages) { %>
                                <li class="page-item">
                                    <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= search %>">Suivante</a>
                                </li>
                            <% } else { %>
                                <li class="page-item disabled">
                                    <a class="page-link">Suivante</a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                </div>
            </div>
       </div>
  </div>
<%- include('../admin/composants/footer') %>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script src="/admin/js/utilities/titleFunction.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const marriageContainer = document.querySelector('.row.marriage-container');
    const puppyWarningModal = new bootstrap.Modal(document.getElementById('puppyWarningModal'));
    searchInput.addEventListener('input', function() {
        const query = searchInput.value.toLowerCase();
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('search', query);
        urlParams.set('page', 1);
        const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
        history.pushState(null, '', newUrl);
        fetch(newUrl)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newMarriages = doc.querySelector('.row.marriage-container').innerHTML;
                marriageContainer.innerHTML = newMarriages;
                attachEvents();
            });
    });
    function attachEvents() {
        const viewPuppiesButtons = document.querySelectorAll('.view-puppies-btn');
        viewPuppiesButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                if (this.classList.contains('disabled')) {
                    event.preventDefault();
                    puppyWarningModal.show();
                }
            });
        });

        const marriageCards = document.querySelectorAll('.card');
        marriageCards.forEach(card => {
            card.addEventListener('click', function(event) {
                const viewPuppiesBtn = this.querySelector('.view-puppies-btn');
                if (viewPuppiesBtn.classList.contains('disabled')) {
                    event.preventDefault();
                    puppyWarningModal.show();
                } else {
                    window.location.href = viewPuppiesBtn.href;
                }
            });
        });
    }

    // Attacher les événements initiaux
    attachEvents();

    // Ajoutez cet écouteur pour gérer la fermeture de la modale
    document.getElementById('puppyWarningModal').addEventListener('hidden.bs.modal', function () {
        // Code à exécuter après la fermeture de la modale, si nécessaire
    });
});
</script>
<!-- Modal -->
<div class="modal fade" id="puppyWarningModal" tabindex="-1" aria-labelledby="puppyWarningModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="puppyWarningModalLabel">Accès refusé</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Pour accéder à la gestion des chiots, vous devez d'abord inscrire la date de naissance, le nombre exact de mâle(s) et de femelle(s) sur la page Mariages.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  
</body>
</html>
